(()=>{"use strict";const e=[{id:"framer-minimal",name:"Framer Minimal",styles:{backgroundColor:"#FFFFFF",textColor:"#000000",buttonColor:"#0099FF",displayColor:"#F5F5F5",displayTextColor:"#000000",accentColor:"#0099FF",borderRadius:"12px"}},{id:"framer-dark",name:"Framer Dark",styles:{backgroundColor:"#1E1E1E",textColor:"#FFFFFF",buttonColor:"#0099FF",displayColor:"#2D2D2D",displayTextColor:"#FFFFFF",accentColor:"#0099FF",borderRadius:"12px"}},{id:"te-op1",name:"TE OP-1",styles:{backgroundColor:"#FFCC00",textColor:"#000000",buttonColor:"#000000",displayColor:"#111111",displayTextColor:"#FFFFFF",accentColor:"#FF0000",borderRadius:"4px"}},{id:"te-op1-dark",name:"TE OP-1 Dark",styles:{backgroundColor:"#222222",textColor:"#FFFFFF",buttonColor:"#FFCC00",displayColor:"#000000",displayTextColor:"#FFCC00",accentColor:"#FFCC00",borderRadius:"4px"}},{id:"neo-mint",name:"Neo Mint",styles:{backgroundColor:"#BDEED0",textColor:"#2A3B47",buttonColor:"#0CC0DF",displayColor:"#FFFFFF",displayTextColor:"#2A3B47",accentColor:"#FF6B95",borderRadius:"16px"}},{id:"vapor-wave",name:"Vapor Wave",styles:{backgroundColor:"#131377",textColor:"#FFFFFF",buttonColor:"#FF00FF",displayColor:"#000000",displayTextColor:"#00FFFF",accentColor:"#FF00FF",borderRadius:"0px"}},{id:"ipod-classic",name:"iPod Classic",styles:{backgroundColor:"#ECECEC",textColor:"#000000",buttonColor:"#6A6A6A",displayColor:"#D6DCE4",displayTextColor:"#000000",accentColor:"#007AFF",borderRadius:"8px"}},{id:"minimal-player",name:"미니멀 플레이어 (앨범아트 없음)",styles:{backgroundColor:"#F8F8F8",textColor:"#333333",buttonColor:"#555555",displayColor:"#FFFFFF",displayTextColor:"#333333",accentColor:"#555555",borderRadius:"4px"}}];class t{constructor(){console.log("ThemeManager 초기화 시작");try{if(!e||0===e.length)throw console.error("테마 데이터가 비어 있습니다"),new Error("테마 데이터가 비어 있습니다");const t=e.find((e=>"te-op1"===e.id));t?(this.currentTheme=t,console.log(`기본 테마 설정됨: ${t.name}`)):(this.currentTheme=e[0],console.log(`기본 테마를 찾을 수 없어 첫 번째 테마로 설정: ${e[0].name}`))}catch(e){console.error("ThemeManager 초기화 중 오류:",e),this.currentTheme={id:"default",name:"Default Theme",styles:{backgroundColor:"#FFFFFF",textColor:"#000000",buttonColor:"#0099FF",displayColor:"#F5F5F5",displayTextColor:"#000000",accentColor:"#0099FF",borderRadius:"4px"}}}}static getInstance(){return t.instance||(t.instance=new t),t.instance}getCurrentTheme(){return this.currentTheme}setCurrentTheme(e){e?(console.log(`테마 변경: ${e.name} (${e.id})`),this.currentTheme=e):console.error("유효하지 않은 테마가 설정되었습니다")}getThemeById(t){if(t)try{const o=e.find((e=>e.id===t));return o||console.warn(`테마를 찾을 수 없음: ${t}`),o}catch(e){return void console.error(`테마 검색 중 오류 (ID: ${t}):`,e)}else console.error("유효하지 않은 테마 ID입니다")}getAllThemes(){return[...e]}generateCSSVariables(e){try{if(!e||!e.styles)throw console.error("유효하지 않은 테마 데이터"),new Error("유효하지 않은 테마 데이터");const{styles:t}=e;return console.log("CSS 변수 생성:",e.id),`\n        :root {\n          --theme-background: ${t.backgroundColor};\n          --theme-text: ${t.textColor};\n          --theme-button: ${t.buttonColor};\n          --theme-display: ${t.displayColor};\n          --theme-display-text: ${t.displayTextColor};\n          --theme-accent: ${t.accentColor};\n          --theme-radius: ${t.borderRadius};\n        }\n      `}catch(e){return console.error("CSS 변수 생성 중 오류:",e),"\n        :root {\n          --theme-background: #FFFFFF;\n          --theme-text: #000000;\n          --theme-button: #0099FF;\n          --theme-display: #F5F5F5;\n          --theme-display-text: #000000;\n          --theme-accent: #0099FF;\n          --theme-radius: 4px;\n        }\n      "}}applyThemeToFigmaNode(e,t){try{if(!e)return void console.error("유효하지 않은 Figma 노드");if(!t||!t.styles)return void console.error("유효하지 않은 테마 데이터");const{styles:o}=t;e.fills=[{type:"SOLID",color:this.hexToRGB(o.backgroundColor)}],e.strokes=[{type:"SOLID",color:this.hexToRGB(o.textColor)}],e.cornerRadius=parseInt(o.borderRadius)||4,e.setPluginData("themeId",t.id),console.log(`테마 ${t.id}가 Figma 노드에 적용됨`)}catch(e){console.error("Figma 노드에 테마 적용 중 오류:",e)}}hexToRGB(e){try{if(!e||"string"!=typeof e)throw new Error("유효하지 않은 HEX 색상 값");if(e=e.replace("#",""),!/^[0-9A-Fa-f]{6}$/.test(e))throw new Error("유효하지 않은 HEX 형식");const t=parseInt(e.substring(0,2),16)/255;return{r:t,g:parseInt(e.substring(2,4),16)/255,b:parseInt(e.substring(4,6),16)/255}}catch(e){return console.error("HEX to RGB 변환 중 오류:",e),{r:0,g:0,b:0}}}}class o{constructor(){this.trackCache=new Map,this.CACHE_KEY="figma_music_player_cache_v4",console.log("TrackService 초기화 - v4"),this.clearCache()}static getInstance(){return o.instance||(o.instance=new o),o.instance}getPredefinedTracks(){return console.log("최신 기본 트랙 목록 가져오기"),[{title:"Ara Bada",artist:"Kuf-G",url:"https://soundcloud.com/kuf-g/ara-bada"},{title:"TX-6 + OP-1 Field Jam",artist:"HAINBACH",url:"https://soundcloud.com/euna34everywhere/sunshower"},{title:"EP-133 First Impressions",artist:"Red Means Recording",url:"https://soundcloud.com/user-190687460/sunday"}]}getTrackMetadata(e){return t=this,o=void 0,r=function*(){try{if(!e)throw new Error("유효하지 않은 URL");if(this.trackCache.has(e))return this.trackCache.get(e);const t=yield fetch(`https://soundcloud.com/oembed?url=${encodeURIComponent(e)}&format=json`);if(!t.ok)throw new Error(`API 응답 오류: ${t.status}`);const o=yield t.json(),s={title:o.title.split(" by ")[0]||o.title,artist:o.title.includes(" by ")?o.title.split(" by ")[1]:"Unknown Artist",url:e,artwork:o.thumbnail_url};return this.trackCache.set(e,s),s}catch(t){return console.error("트랙 메타데이터 가져오기 실패:",t),{title:"Unknown Track",artist:"Unknown Artist",url:e||"https://soundcloud.com/"}}},new((s=void 0)||(s=Promise))((function(e,i){function n(e){try{a(r.next(e))}catch(e){i(e)}}function l(e){try{a(r.throw(e))}catch(e){i(e)}}function a(t){var o;t.done?e(t.value):(o=t.value,o instanceof s?o:new s((function(e){e(o)}))).then(n,l)}a((r=r.apply(t,o||[])).next())}));var t,o,s,r}clearCache(){this.trackCache.clear();try{localStorage.removeItem(this.CACHE_KEY)}catch(e){console.error("캐시 삭제 중 오류:",e)}}}new class{constructor(){this.trackList=null,this.scIframe=null,this.previewContainer=null,this.previewTitle=null,this.previewArtist=null,this.statusDot=null,this.playPauseBtn=null,this.themeSelect=null,this.progressBar=null,this.timeDisplay=null,this.selectedTrack=null,this.scPlayer=null,this.isPlaying=!1,this.tracks=[],this.availableThemes=[],console.log("PlayerUI 초기화 - v4.0.0"),this.themeManager=t.getInstance(),this.trackService=o.getInstance(),this.currentTheme=this.themeManager.getCurrentTheme(),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",this.onDomLoaded.bind(this)):this.onDomLoaded()}onDomLoaded(){this.initializeDOM(),this.loadData(),this.setupEventListeners(),this.initSoundCloudAPI()}initializeDOM(){this.trackList=document.getElementById("track-list"),this.scIframe=document.getElementById("sc-iframe"),this.previewContainer=document.getElementById("preview-container"),this.previewTitle=document.getElementById("preview-title"),this.previewArtist=document.getElementById("preview-artist"),this.statusDot=document.getElementById("status-dot"),this.playPauseBtn=document.getElementById("player-play-btn"),this.themeSelect=document.getElementById("theme-select"),this.progressBar=document.getElementById("progress-bar"),this.timeDisplay=document.getElementById("time-display"),this.trackList&&this.scIframe&&this.previewContainer&&this.previewTitle&&this.previewArtist&&this.statusDot&&this.playPauseBtn&&this.themeSelect&&this.progressBar&&this.timeDisplay||console.error("필요한 DOM 요소를 찾을 수 없습니다")}loadData(){this.tracks=this.trackService.getPredefinedTracks(),console.log("트랙 목록 로드:",this.tracks),this.availableThemes=this.themeManager.getAllThemes(),console.log("테마 목록 로드:",this.availableThemes),this.initThemeSelect(),this.displayTracks(),this.applyTheme(this.currentTheme)}initThemeSelect(){this.themeSelect&&(this.themeSelect.innerHTML="",this.availableThemes.forEach((e=>{const t=document.createElement("option");t.value=e.id,t.textContent=e.name,this.themeSelect.appendChild(t)})),this.themeSelect.value=this.currentTheme.id)}displayTracks(){this.trackList&&(this.trackList.innerHTML="",this.tracks.forEach(((e,t)=>{const o=document.createElement("div");o.className="track-item",o.id=`track-${t}`,o.innerHTML=`\n        <div class="track-info">\n          <div class="track-title">${e.title}</div>\n          <div class="track-artist">${e.artist}</div>\n        </div>\n      `,o.addEventListener("click",(()=>{this.selectTrack(e,o)})),this.trackList.appendChild(o)})),setTimeout((()=>{const e=document.getElementById("track-0");e&&this.tracks.length>0&&e.click()}),200))}selectTrack(e,t){if(console.log(`트랙 선택: ${e.title} - ${e.artist}`),this.selectedTrack=e,document.querySelectorAll(".track-item").forEach((e=>{e.classList.remove("selected")})),t.classList.add("selected"),this.previewContainer&&this.previewTitle&&this.previewArtist&&(this.previewContainer.style.display="block",this.previewTitle.textContent=e.title,this.previewArtist.textContent=e.artist,this.scIframe)){const t=this.currentTheme.styles.accentColor.replace("#",""),o=encodeURIComponent(e.url);console.log(`SoundCloud 트랙 URL: ${o}`);const s=`https://w.soundcloud.com/player/?url=${o}&color=${t}&auto_play=true&hide_related=true&show_comments=false&show_user=true&show_reposts=false&show_teaser=false&visual=false`;console.log(`SoundCloud iframe URL: ${s}`),this.scIframe.src=s,setTimeout((()=>{this.initSoundCloudPlayer()}),1e3)}this.showToast(`재생 중: ${e.title}`)}initSoundCloudAPI(){console.log("SoundCloud API 초기화 시도");const e=()=>!(!window.SC||!window.SC.Widget||(console.log("SoundCloud API 로드 완료"),0));if(e())return void console.log("SoundCloud API 이미 로드됨");console.log("SoundCloud API 로드 대기 중...");let t=0;const o=setInterval((()=>{if(t++,console.log(`SoundCloud API 로드 확인 시도 ${t}/10`),e()||t>=10)if(clearInterval(o),e())console.log("SoundCloud API 로드 성공");else{console.error("SoundCloud API 로드 실패");const e=document.createElement("script");e.src="https://w.soundcloud.com/player/api.js",document.head.appendChild(e)}}),500)}initSoundCloudPlayer(){if(this.scIframe){if(!window.SC||!window.SC.Widget)return console.error("SoundCloud API가 로드되지 않았습니다"),this.initSoundCloudAPI(),void setTimeout((()=>this.initSoundCloudPlayer()),1e3);try{if(console.log("SoundCloud 플레이어 초기화 시작"),!this.scIframe.src||"about:blank"===this.scIframe.src)return void console.error("SoundCloud iframe에 유효한 URL이 없습니다");this.scPlayer=window.SC.Widget(this.scIframe),this.scPlayer.bind(window.SC.Widget.Events.READY,(()=>{console.log("SoundCloud 플레이어 준비 완료"),this.scPlayer.play()})),this.scPlayer.bind(window.SC.Widget.Events.PLAY,(()=>{this.isPlaying=!0,this.updatePlayStatus(!0),console.log("SoundCloud 트랙 재생 시작")})),this.scPlayer.bind(window.SC.Widget.Events.PAUSE,(()=>{this.isPlaying=!1,this.updatePlayStatus(!1),console.log("SoundCloud 트랙 일시정지")})),this.scPlayer.bind(window.SC.Widget.Events.FINISH,(()=>{console.log("SoundCloud 트랙 재생 완료, 다음 트랙으로 이동"),this.playNextTrack()})),this.scPlayer.bind(window.SC.Widget.Events.PLAY_PROGRESS,(e=>{this.updateProgress(e.currentPosition,e.relativePosition)})),console.log("SoundCloud 플레이어 이벤트 바인딩 완료")}catch(e){console.error("SoundCloud 플레이어 초기화 오류:",e)}}else console.error("SoundCloud iframe을 찾을 수 없습니다")}updatePlayStatus(e){this.statusDot&&this.statusDot.classList.toggle("playing",e),this.playPauseBtn&&(this.playPauseBtn.innerHTML=e?'<svg viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>':'<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>')}updateProgress(e,t){if(this.progressBar&&(this.progressBar.style.width=100*t+"%"),this.timeDisplay){const t=this.formatTime(e);let o="0:00";try{this.scPlayer&&this.scPlayer.getDuration((e=>{o=this.formatTime(e),this.timeDisplay&&(this.timeDisplay.textContent=`${t} / ${o}`)}))}catch(e){this.timeDisplay&&(this.timeDisplay.textContent=`${t} / ${o}`)}}}formatTime(e){const t=Math.floor(e/1e3);return`${Math.floor(t/60)}:${(t%60).toString().padStart(2,"0")}`}playNextTrack(){const e=this.tracks.findIndex((e=>e===this.selectedTrack));if(e<this.tracks.length-1){const t=this.tracks[e+1],o=document.getElementById(`track-${e+1}`);o&&this.selectTrack(t,o)}}togglePlayback(){if(this.scPlayer)try{this.isPlaying?this.scPlayer.pause():this.scPlayer.play()}catch(e){console.error("재생 토글 중 오류:",e)}}setupEventListeners(){this.themeSelect&&this.themeSelect.addEventListener("change",(e=>{const t=e.target.value,o=this.availableThemes.find((e=>e.id===t));o&&(this.currentTheme=o,this.themeManager.setCurrentTheme(o),this.applyTheme(o))})),this.playPauseBtn&&this.playPauseBtn.addEventListener("click",(()=>{this.togglePlayback()})),this.progressBar&&this.progressBar.parentElement&&this.progressBar.parentElement.addEventListener("click",(e=>{if(!this.scPlayer)return;const t=this.progressBar.parentElement.getBoundingClientRect(),o=(e.clientX-t.left)/t.width;o>=0&&o<=1&&this.scPlayer.getDuration((e=>{const t=e*o;this.scPlayer.seekTo(t)}))}))}applyTheme(e){const t=document.documentElement,o=e.styles;t.style.setProperty("--theme-background",o.backgroundColor),t.style.setProperty("--theme-text",o.textColor),t.style.setProperty("--theme-button",o.buttonColor),t.style.setProperty("--theme-display",o.displayColor),t.style.setProperty("--theme-display-text",o.displayTextColor),t.style.setProperty("--theme-accent",o.accentColor),t.style.setProperty("--theme-radius",o.borderRadius),this.showToast(`테마 변경: ${e.name}`)}showToast(e,t=2e3){const o=document.getElementById("plugin-toast");o&&o.remove();const s=document.createElement("div");s.id="plugin-toast",s.textContent=e,document.body.appendChild(s),setTimeout((()=>{s.style.opacity="1"}),10),setTimeout((()=>{s.style.opacity="0",setTimeout((()=>{s.remove()}),300)}),t)}}})();