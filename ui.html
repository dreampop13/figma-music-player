<!DOCTYPE html>
<html>
  <head>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');
      @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap');
      
      :root {
        --theme-background: #FFCC00;
        --theme-text: #000000;
        --theme-button: #000000;
        --theme-display: #111111;
        --theme-display-text: #FFFFFF;
        --theme-accent: #FF0000;
        --theme-radius: 4px;
        --transition-speed: 0.3s;
        --font-primary: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        --font-mono: 'JetBrains Mono', monospace;
        --font-pixel: 'Press Start 2P', cursive;
        --space-xxs: 3px;
        --space-xs: 4px;
        --space-sm: 6px;
        --space-md: 10px;
        --space-lg: 16px;
        --space-xl: 22px;
        --player-height: 90px; /* 감소된 플레이어 높이 */
        --mini-scale: 0.7; /* 더 작은 전체적인 크기 축소 비율 */
        --font-xs: 8px;
        --font-sm: 10px;
        --font-md: 12px;
        --font-lg: 14px;
        --radius-sm: 4px;
        --radius-md: 6px;
        --radius-lg: 8px;
        --theme-radius-fixed: 8px;
      }

      body {
        font-family: var(--font-primary);
        margin: 0;
        padding: 0 var(--space-md);
        background-color: var(--theme-background);
        color: var(--theme-text);
        transition: background-color var(--transition-speed) ease;
        -webkit-font-smoothing: antialiased;
        font-size: 14px;
      }
      
      .container {
        display: flex;
        flex-direction: column;
        gap: var(--space-xs);
        width: 100%;
        max-width: 280px;
        margin: 0 auto;
        padding: var(--space-xs) 0 var(--space-md) 0; /* Add more padding at bottom */
      }

      .header {
        display: none;
      }

      .logo {
        font-weight: 600;
        font-size: 10px;
        letter-spacing: 1px;
        color: var(--theme-text);
        transition: color var(--transition-speed) ease;
      }

      .theme-selector {
        margin-bottom: var(--space-sm);
      }

      .theme-selector select {
        width: 100%;
        padding: var(--space-xs) var(--space-sm);
        background-color: transparent;
        color: var(--theme-text);
        font-size: 12px;
        transition: all var(--transition-speed) ease;
        border: 1px solid rgba(0, 0, 0, 0.2);
        border-radius: var(--theme-radius-fixed);
        appearance: none;
        background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23000000%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
        background-repeat: no-repeat;
        background-position: right 8px top 50%;
        background-size: 8px auto;
        padding-right: 20px;
      }
      
      .theme-selector select:focus {
        outline: none;
        box-shadow: 0 0 0 1px var(--theme-accent);
      }

      .playlist-title {
        font-size: 11px;
        font-weight: 500;
        color: var(--theme-text);
        opacity: 0.8;
        margin-bottom: var(--space-xs);
        display: block;
      }

      .track-list {
        display: flex;
        flex-direction: column;
        gap: 3px;
        border: 1px solid rgba(0, 0, 0, 0.2);
        border-radius: var(--theme-radius-fixed);
        padding: var(--space-sm);
        background-color: rgba(255, 255, 255, 0.05);
        transition: border-radius var(--transition-speed) ease, 
                   border-color var(--transition-speed) ease;
        margin-bottom: var(--space-sm);
      }

      .track-item {
        display: flex;
        align-items: center;
        padding: var(--space-xs) var(--space-sm);
        border-radius: var(--theme-radius);
        cursor: pointer;
        transition: background-color 0.2s, border-radius var(--transition-speed) ease;
        position: relative;
        overflow: hidden;
        min-height: 38px; /* Slightly reduced height */
        box-sizing: border-box;
      }

      .track-item:hover {
        background-color: rgba(0, 0, 0, 0.07);
      }

      .track-item.selected {
        background-color: var(--theme-button);
        color: #FFFFFF;
      }
      
      .track-item.selected::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        height: 100%;
        width: 2px;
        background-color: var(--theme-accent);
      }

      .track-info {
        flex: 1;
        padding: var(--space-xxs) 0;
      }

      .track-title {
        font-weight: 600;
        font-size: 12px;
        margin-bottom: 3px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .track-artist {
        font-size: 10px;
        opacity: 0.7;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .preview-player {
        border-radius: var(--theme-radius);
        margin-bottom: var(--space-sm);
        transition: border-radius var(--transition-speed) ease;
        overflow: hidden;
        width: 100%;
      }

      .preview-display {
        background-color: var(--theme-display);
        border-radius: var(--theme-radius-fixed) !important;
        padding: var(--space-sm) var(--space-md);
        color: var(--theme-display-text);
        transition: all var(--transition-speed) ease;
        border: 1px solid rgba(0, 0, 0, 0.1);
      }
      
      /* iPod Classic specific styles - update to monochrome */
      .ipod-classic .preview-display {
        font-family: var(--font-mono);
        font-size: 10px;
        filter: grayscale(100%); /* Force grayscale on the display */
      }
      
      .ipod-classic .track-title, 
      .ipod-classic .preview-title {
        font-family: var(--font-mono);
      }
      
      .ipod-classic .now-playing span,
      .ipod-classic .preview-artist {
        font-family: var(--font-mono);
        letter-spacing: -0.5px;
      }
      
      .ipod-classic .status-dot {
        background-color: #666666 !important; /* Force gray status dot */
      }
      
      .ipod-classic .status-dot.playing {
        background-color: #333333 !important; /* Darker gray when playing */
        box-shadow: 0 0 3px #333333 !important;
      }
      
      .ipod-classic .progress-bar {
        background-color: #666666 !important; /* Gray progress bar */
      }
      
      /* Vapor Wave specific styles */
      .vapor-wave .preview-display {
        font-family: var(--font-pixel);
        font-size: 8px;
      }
      
      /* 미니멀 플레이어 스타일 (앨범아트 없음) */
      .minimal-player .preview-display {
        font-family: var(--font-primary);
        font-size: 11px;
        padding: var(--space-xs) var(--space-sm);
      }
      
      /* 미니멀 플레이어에서는 더 간결한 UI 표시 */
      .minimal-player .preview-title {
        font-weight: 500;
        text-transform: none;
      }
      
      .minimal-player .preview-artist {
        text-transform: none;
      }
      
      /* 미니멀 플레이어 전용 스타일 (앨범아트 숨김) */
      .minimal-player .preview-iframe {
        height: 45px;
        background-color: var(--theme-button);
        opacity: 0.9;
      }
      
      /* 플레이어 iframe 스타일 통일 */
      .preview-iframe {
        width: 100%;
        height: 80px;
        border: none;
        margin-top: var(--space-xxs);
        border-radius: var(--theme-radius);
        transition: border-radius var(--transition-speed) ease;
      }
      
      .now-playing {
        display: block;
        position: relative;
        height: 20px;
        margin-bottom: var(--space-sm);
        text-align: left;
      }
      
      .now-playing span {
        position: absolute;
        left: 0;
        font-size: 10px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      
      .status-dot {
        position: absolute;
        right: 0;
        top: 7px;
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background-color: red;
        transition: background-color 0.6s ease;
      }

      .status-dot.playing {
        background-color: #00ff85;
        box-shadow: 0 0 3px #00ff85;
      }
      
      .preview-title {
        font-size: 13px;
        font-weight: bold;
        margin-top: 8px;
        margin-bottom: 3px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .preview-artist {
        font-size: 11px;
        opacity: 0.8;
        margin-bottom: var(--space-xs);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .footer {
        margin-top: 0;
        text-align: center;
        font-size: 8px;
        color: var(--theme-text);
        opacity: 0.6;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      #debug-version {
        background: rgba(0, 0, 0, 0.1);
        color: var(--theme-text);
        padding: var(--space-sm) var(--space-md); 
        margin-bottom: var(--space-sm); 
        font-size: 11px;
        font-weight: 500; 
        text-align: center;
        border-radius: var(--theme-radius-fixed) !important;
        letter-spacing: 0.5px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }
      
      /* 트랙 항목 로딩 애니메이션 */
      @keyframes trackItemFadeIn {
        from { opacity: 0; transform: translateY(3px); }
        to { opacity: 1; transform: translateY(0); }
      }
      
      .track-item {
        animation: trackItemFadeIn 0.3s ease forwards;
      }
      
      .track-item:nth-child(1) { animation-delay: 0.05s; }
      .track-item:nth-child(2) { animation-delay: 0.1s; }
      .track-item:nth-child(3) { animation-delay: 0.15s; }

      /* 테마 전환 중 애니메이션 */
      body.theme-transition {
        transition: background-color 0.3s ease;
      }
      
      body.theme-transition * {
        transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
      }
      
      /* 토스트 메시지 스타일 */
      #plugin-toast {
        position: fixed;
        bottom: 15px;
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 5px 16px;
        border-radius: var(--theme-radius-fixed);
        font-size: 9px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        z-index: 100;
        opacity: 0;
        min-width: 156px;
        max-width: 90%;
        text-align: center;
        backdrop-filter: blur(4px);
        -webkit-backdrop-filter: blur(4px);
        transition: opacity 0.3s ease;
      }
      
      /* Track item loading animation and style adjustment */
      .track-item.loading {
        position: relative;
        opacity: 0.7;
      }
      
      .track-item.loading small {
        display: block;
        font-size: 10px;
        padding: 7px var(--space-sm); /* Reduced vertical padding */
        margin: 0;
        opacity: 0.8;
        line-height: 1.1;
      }
      
      .track-item.loading:after {
        content: '';
        position: absolute;
        width: 100%;
        height: 1px;
        bottom: 0;
        left: 0;
        background: linear-gradient(90deg, transparent, var(--theme-accent), transparent);
        animation: loadingSlide 1.5s infinite;
      }
      
      @keyframes loadingSlide {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
      }

      /* 작은 화면에서 여백 조정 */
      @media (max-width: 340px) {
        body {
          padding: var(--space-xs) var(--space-xs);
        }
        
        .preview-display {
          padding: var(--space-sm) var(--space-sm);
        }
      }

      .player-card {
        border-radius: var(--radius-lg);
        overflow: hidden;
        transition: all 0.2s ease;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      
      .sc-player {
        padding: var(--space-sm);
        display: grid;
        grid-template-columns: 40px 1fr;
        grid-gap: var(--space-sm);
      }
      
      .sc-player .album-art {
        width: 40px;
        height: 40px;
        border-radius: var(--radius-sm);
        overflow: hidden;
      }
      
      .sc-player .controls {
        display: flex;
        gap: var(--space-xs);
        margin-top: var(--space-xs);
      }
      
      .sc-player .controls button {
        padding: var(--space-xs);
        border-radius: var(--radius-sm);
        width: 22px;
        height: 22px;
      }
      
      .sc-player .track-info {
        font-size: var(--font-sm);
        margin-bottom: var(--space-xs);
      }
      
      .sc-player .artist {
        font-size: var(--font-xs);
        opacity: 0.8;
      }

      /* New player layout with album art */
      .player-content {
        display: flex;
        align-items: center;
        gap: var(--space-sm);
        margin-bottom: var(--space-sm);
      }
      
      .album-art-mini {
        width: 30px;
        height: 30px;
        border-radius: 4px;
        background-color: rgba(0, 0, 0, 0.2);
        overflow: hidden;
        position: relative;
      }
      
      .album-art-mini img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      
      .track-info-mini {
        flex: 1;
        overflow: hidden;
      }
      
      .now-playing {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        margin-bottom: var(--space-xxs);
      }
      
      .preview-display {
        background-color: var(--theme-display);
        border-radius: var(--theme-radius-fixed) !important;
        padding: var(--space-sm) var(--space-md);
        color: var(--theme-display-text);
        transition: all var(--transition-speed) ease;
        border: 1px solid rgba(0, 0, 0, 0.1);
      }
      
      /* Update figma plugin size */
      @media (max-width: 280px) {
        body {
          padding: 0;
          overflow-x: hidden;
        }
        
        .container {
          max-width: 100%;
          padding: var(--space-xxs);
        }
      }

      /* Fix duplicate styling and add margin */
      .now-playing-container {
        background-color: rgba(0, 0, 0, 0.1);
        border-radius: var(--theme-radius-fixed) !important;
        padding: var(--space-md);
        margin: var(--space-sm) 0 5px 0;
        position: relative;
        border: none;
      }
      
      /* Fix the play button border radius */
      .play-button {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background-color: var(--theme-button);
        display: flex;
        align-items: center;
        justify-content: center;
        border: none;
        cursor: pointer;
        color: #fff;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
        transition: all 0.2s ease;
      }
      
      .play-button:hover {
        transform: scale(1.05);
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
      }
      
      .play-button svg {
        width: 16px;
        height: 16px;
        fill: currentColor;
      }
      
      .player-controls {
        display: flex;
        align-items: center;
        justify-content: flex-start;
        margin-top: var(--space-sm);
        padding-left: 0;
        gap: var(--space-md);
      }
      
      .progress-container {
        flex: 1;
        height: 5px;
        background-color: rgba(255, 255, 255, 0.2);
        border-radius: 2px;
        overflow: hidden;
        position: relative;
        cursor: pointer;
      }
      
      .progress-bar {
        position: absolute;
        left: 0;
        top: 0;
        height: 100%;
        background-color: var(--theme-accent);
        width: 30%;
      }
      
      .time-display {
        font-size: 10px;
        opacity: 0.7;
      }

      /* Remove any leftover album-art-mini and player-content styles */
      .album-art-mini, .player-content {
        display: none;
      }
      
      /* Adjust theme selector spacing */
      .theme-selector {
        margin-bottom: var(--space-sm);
      }
      
      .theme-selector select {
        width: 100%;
        padding: var(--space-xs) var(--space-sm);
        background-color: transparent;
        color: var(--theme-text);
        font-size: 12px;
        transition: all var(--transition-speed) ease;
        border: 1px solid rgba(0, 0, 0, 0.2);
        border-radius: var(--theme-radius-fixed);
        appearance: none;
        background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23000000%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
        background-repeat: no-repeat;
        background-position: right 8px top 50%;
        background-size: 8px auto;
        padding-right: 20px;
      }
      
      /* Debug version style */
      #debug-version {
        background: var(--theme-accent); 
        color: white; 
        padding: var(--space-xxs) var(--space-xs); 
        margin-bottom: var(--space-sm); 
        font-size: 10px; 
        text-align: center;
        border-radius: var(--theme-radius-fixed);
      }

      /* Ensure consistent UI size by giving preview container a min-height */
      #preview-container {
        min-height: 185px;
      }
      
      /* Initially show preview container with placeholder */
      #preview-container.empty {
        display: block !important;
        opacity: 0.5;
      }
      
      /* Reset the now-playing styles completely */
      .now-playing {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--space-sm);
        width: 100%;
      }
      
      .now-playing span {
        font-size: 10px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      
      .now-playing .status-dot {
        position: absolute;
        right: 0;
      }

      /* Fix NOW PLAYING text alignment */
      .preview-display .now-playing {
        text-align: left;
      }

      /* Loading text style */
      .track-item.loading {
        font-size: 10px;
        opacity: 0.7;
      }
      
      /* Loading animation */
      @keyframes loadingSlide {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
      }
      
      /* Loading style with smaller font */
      .track-item.loading:after {
        content: '';
        position: absolute;
        width: 100%;
        height: 1px;
        bottom: 0;
        left: 0;
        background: linear-gradient(90deg, transparent, var(--theme-accent), transparent);
        animation: loadingSlide 1.5s infinite;
      }

      /* Override theme radius with fixed value */
      .track-list,
      .theme-selector select,
      .preview-display,
      .now-playing-container,
      #debug-version,
      #plugin-toast {
        border-radius: var(--theme-radius-fixed) !important;
        transition: background-color var(--transition-speed) ease, 
                   color var(--transition-speed) ease;
      }
      
      /* Maintain consistent stroke */
      .track-list {
        border: 1px solid rgba(0, 0, 0, 0.2);
      }
      
      .theme-selector select {
        border: 1px solid rgba(0, 0, 0, 0.2);
      }
    </style>
    <script>
      // 전역 상태 객체 초기화
      window._savedSCPlayerState = {
        position: 0,
        isPlaying: false
      };
      
      // 디버깅 함수
      window.debugFigmaPlugin = {
        logDom: function() {
          console.log('DOM 요소 검사:');
          const elements = {
            'track-list': document.getElementById('track-list'),
            'theme-select': document.getElementById('theme-select'),
            'sc-iframe': document.getElementById('sc-iframe'),
            'preview-container': document.getElementById('preview-container'),
            'preview-title': document.getElementById('preview-title'),
            'preview-artist': document.getElementById('preview-artist'),
            'status-dot': document.getElementById('status-dot'),
            'play-icon': document.getElementById('play-icon'),
            'pause-icon': document.getElementById('pause-icon'),
            'play-pause-btn': document.getElementById('play-pause-btn'),
            'insert-button': document.getElementById('insert-button')
          };
          
          for (const [id, element] of Object.entries(elements)) {
            console.log(`${id}: ${element ? '존재함' : '존재하지 않음'}`);
          }
          return elements;
        },
        
        // 테마 확인 및 생성
        checkThemes: function() {
          // 하드코딩된 테마 데이터
          const themes = [
            {
              id: "framer-minimal",
              name: "Modern (Default)",
              styles: {
                backgroundColor: "#FFFFFF",
                textColor: "#000000",
                buttonColor: "#0099FF",
                displayColor: "#F5F5F5",
                displayTextColor: "#000000",
                accentColor: "#0099FF",
                borderRadius: "12px"
              }
            },
            {
              id: "framer-dark",
              name: "Modern (Dark)",
              styles: {
                backgroundColor: "#1E1E1E", 
                textColor: "#FFFFFF",
                buttonColor: "#0099FF",
                displayColor: "#2D2D2D",
                displayTextColor: "#FFFFFF",
                accentColor: "#0099FF",
                borderRadius: "12px"
              }
            },
            {
              id: "te-op1",
              name: "TE OP-1",
              styles: {
                backgroundColor: "#FFCC00",
                textColor: "#000000",
                buttonColor: "#000000",
                displayColor: "#111111",
                displayTextColor: "#FFFFFF",
                accentColor: "#FF0000",
                borderRadius: "4px"
              }
            },
            {
              id: "te-op1-dark",
              name: "TE OP-1 Dark",
              styles: {
                backgroundColor: "#222222",
                textColor: "#FFFFFF",
                buttonColor: "#FFCC00",
                displayColor: "#000000",
                displayTextColor: "#FFCC00",
                accentColor: "#FFCC00",
                borderRadius: "4px"
              }
            },
            {
              id: "neo-mint",
              name: "Neo Mint",
              styles: {
                backgroundColor: "#BDEED0",
                textColor: "#2A3B47",
                buttonColor: "#0CC0DF",
                displayColor: "#FFFFFF",
                displayTextColor: "#2A3B47",
                accentColor: "#FF6B95",
                borderRadius: "16px"
              }
            },
            {
              id: "vapor-wave",
              name: "Vapor Wave",
              styles: {
                backgroundColor: "#131377",
                textColor: "#FFFFFF",
                buttonColor: "#FF00FF",
                displayColor: "#000000",
                displayTextColor: "#00FFFF",
                accentColor: "#FF00FF",
                borderRadius: "0px"
              }
            },
            {
              id: "ipod-classic",
              name: "iPod Classic",
              styles: {
                backgroundColor: "#ECECEC", // iPod silver body
                textColor: "#000000",
                buttonColor: "#6A6A6A", // Silver button
                displayColor: "#D6DCE4", // Light blue-gray display
                displayTextColor: "#000000",
                accentColor: "#666666", // Changed from Apple blue to dark gray
                borderRadius: "8px"
              }
            }
          ];
          
          // 테마 옵션 직접 채우기
          const themeSelect = document.getElementById('theme-select');
          if (themeSelect) {
            console.log('테마 선택기에 옵션 추가 중...');
            
            // 기존 옵션 제거
            themeSelect.innerHTML = '';
            
            // 옵션 추가
            themes.forEach(theme => {
              const option = document.createElement('option');
              option.value = theme.id;
              option.textContent = theme.name;
              themeSelect.appendChild(option);
              console.log(`테마 옵션 추가됨: ${theme.name}`);
            });
            
            return true;
          } else {
            console.error('테마 선택 요소를 찾을 수 없음');
            return false;
          }
        },
        
        // 테마 직접 적용 (완전히 재작성된 버전)
        applyTheme: function(themeId) {
          const themes = this.getThemes();
          const theme = themes.find(t => t.id === themeId) || themes[2]; // 기본값 TE OP-1
          
          console.log(`테마 직접 적용: ${theme.name}`);
          
          // 테마 전환 애니메이션
          document.body.classList.add('theme-transition');
          
          // 이전 테마 클래스 제거
          document.body.classList.remove('ipod-classic', 'vapor-wave', 'minimal-player');
          
          // 특정 테마 클래스 추가
          if (theme.id === 'ipod-classic') {
            document.body.classList.add('ipod-classic');
          } else if (theme.id === 'vapor-wave') {
            document.body.classList.add('vapor-wave');
          }
          
          // CSS 변수 설정 - border-radius는 업데이트하지 않음
          const root = document.documentElement;
          const { styles } = theme;
          
          root.style.setProperty('--theme-background', styles.backgroundColor);
          root.style.setProperty('--theme-text', styles.textColor);
          root.style.setProperty('--theme-button', styles.buttonColor);
          root.style.setProperty('--theme-display', styles.displayColor);
          root.style.setProperty('--theme-display-text', styles.displayTextColor);
          root.style.setProperty('--theme-accent', styles.accentColor);
          // border-radius는 고정값 사용
          
          // IFRAME 업데이트 - 새로운 접근 방식
          // 기존 iframe을 유지하고 SoundCloud 색상 매개변수만 변경합니다
          const scIframe = document.getElementById('sc-iframe');
          if (scIframe && scIframe.src && scIframe.src.includes('soundcloud.com')) {
            try {
              // 현재 iframe 소스에서 색상만 변경
              const currentUrl = scIframe.src;
              const newColor = styles.accentColor.replace('#', '');
              
              // 1. CSS로 색상 변경 - iframe은 그대로 유지
              const iframeContainer = scIframe.parentElement;
              if (iframeContainer) {
                iframeContainer.style.borderColor = styles.accentColor;
              }
              
              // 알림 표시
              this.showToast(`🎨 ${theme.name}`);
              
              // 우리가 SoundCloud API로 액세스할 필요 없이
              // 2. 기존 iframe 유지 (교체하지 않음)
              // 이렇게 하면 재생 위치가 저절로 유지됨
              
              console.log('테마 적용 완료 - iframe 재생 상태 유지됨');
            } catch (error) {
              console.error('테마 적용 중 오류:', error);
            }
          } else {
            console.log('재생 중인 SoundCloud iframe이 없음');
          }
          
          // 테마 전환 애니메이션 제거
          setTimeout(() => {
            document.body.classList.remove('theme-transition');
          }, 300);
        },
        
        // 토스트 메시지 표시
        showToast: function(message, duration = 1500) {
          try {
            // 기존 토스트 제거
            const existingToast = document.getElementById('plugin-toast');
            if (existingToast) {
              existingToast.remove();
            }
            
            // 새 토스트 생성
            const toast = document.createElement('div');
            toast.id = 'plugin-toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            // 토스트 표시
            setTimeout(() => {
              toast.style.opacity = '0.9';
            }, 10);
            
            // 자동 제거
            setTimeout(() => {
              toast.style.opacity = '0';
              setTimeout(() => {
                toast.remove();
              }, 300);
            }, duration);
          } catch (error) {
            console.error('토스트 표시 중 오류:', error);
          }
        },
        
        // 트랙 선택 시 호출되는 함수를 생성합니다
        createTrackSelector: function(track, trackItem) {
          return function() {
            console.log(`트랙 선택됨: ${track.title}`);
            
            // Get exact dimensions before any changes
            const rect = trackItem.getBoundingClientRect();
            const exactHeight = rect.height;
            
            // Clone track item content for later restoration
            const clone = trackItem.cloneNode(true);
            
            // 로딩 표시 - simplified to reduce height variation
            trackItem.classList.add('loading');
            trackItem.style.height = exactHeight + 'px';
            trackItem.innerHTML = '<small>Loading...</small>';
            
            // 선택 스타일 적용
            document.querySelectorAll('.track-item').forEach(item => {
              item.classList.remove('selected');
            });
            trackItem.classList.add('selected');
            
            // 현재 선택된 테마 색상 가져오기
            const themeSelect = document.getElementById('theme-select');
            const selectedThemeId = themeSelect ? themeSelect.value : 'te-op1';
            const themes = window.debugFigmaPlugin.getThemes();
            const selectedTheme = themes.find(t => t.id === selectedThemeId) || themes[2]; // 기본값 TE OP-1
            const accentColor = selectedTheme.styles.accentColor.replace('#', '');
            
            // 미리보기 표시
            const previewContainer = document.getElementById('preview-container');
            const previewTitle = document.getElementById('preview-title');
            const previewArtist = document.getElementById('preview-artist');
            const scIframe = document.getElementById('sc-iframe');
            
            if (previewContainer && previewTitle && previewArtist) {
              // Remove empty class
              previewContainer.classList.remove('empty');
              
              previewContainer.style.display = 'block';
              previewTitle.textContent = track.title;
              previewArtist.textContent = track.artist;
              
              // SoundCloud iframe 설정 및 재생
              if (scIframe) {
                // iframe 소스 설정 - 앨범아트 표시 최소화를 위해 visual=false로 고정
                const iframeSrc = `https://w.soundcloud.com/player/?url=${encodeURIComponent(track.url)}&color=${accentColor}&auto_play=true&hide_related=true&show_comments=false&show_user=true&show_reposts=false&show_teaser=false&visual=false`;
                scIframe.src = iframeSrc;
                console.log('SoundCloud iframe 소스 설정:', iframeSrc);
                
                // SoundCloud Widget API 초기화
                setTimeout(() => {
                  window.debugFigmaPlugin.initPlayer(scIframe);
                  
                  // 로딩 완료, 원래 콘텐츠 복원
                  trackItem.classList.remove('loading');
                  trackItem.style.height = '';
                  trackItem.style.width = '';
                  
                  // Restore from the clone
                  trackItem.innerHTML = clone.innerHTML;
                  
                  // 토스트 메시지 표시 - 간결하게 변경
                  window.debugFigmaPlugin.showToast(`▶ ${track.title}`);
                }, 1000);
              }
            }
          };
        },
        
        // 트랙 목록 초기화
        createTracks: function() {
          // 하드코딩된 트랙 데이터
          const tracks = [
            {
              title: "OP-1 Field Ambient Session",
              artist: "Red Means Recording",
              url: "https://soundcloud.com/soundsgood_store/monday-mix-sgmm119-lovefool"
            },
            {
              title: "TX-6 + OP-1 Field Jam",
              artist: "HAINBACH",
              url: "https://soundcloud.com/euna34everywhere/sunshower"
            },
            {
              title: "EP-133 First Impressions", 
              artist: "Red Means Recording",
              url: "https://soundcloud.com/user-190687460/sunday"
            }
          ];
          
          // 트랙 목록에 트랙 추가
          const trackList = document.getElementById('track-list');
          if (trackList) {
            console.log('트랙 목록에 트랙 추가 중...');
            
            // 기존 항목 제거
            trackList.innerHTML = '';
            
            // 트랙 추가
            tracks.forEach((track, index) => {
              const trackItem = document.createElement('div');
              trackItem.className = 'track-item';
              trackItem.id = `track-${index}`;
              trackItem.style.animationDelay = `${index * 0.05}s`;
              
              trackItem.innerHTML = `
                <div class="track-info">
                  <div class="track-title">${track.title}</div>
                  <div class="track-artist">${track.artist}</div>
                </div>
              `;
              
              // 클릭 이벤트 추가 - 개선된 방식으로 이벤트 핸들러 생성
              trackItem.addEventListener('click', this.createTrackSelector(track, trackItem));
              
              trackList.appendChild(trackItem);
              console.log(`트랙 추가됨: ${track.title}`);
            });
            
            return true;
          } else {
            console.error('트랙 목록 요소를 찾을 수 없음');
            return false;
          }
        },
        
        // 테마 데이터 반환
        getThemes: function() {
          return [
            {
              id: "framer-minimal",
              name: "Modern (Default)",
              styles: {
                backgroundColor: "#FFFFFF",
                textColor: "#000000",
                buttonColor: "#0099FF",
                displayColor: "#F5F5F5",
                displayTextColor: "#000000",
                accentColor: "#0099FF",
                borderRadius: "12px"
              }
            },
            {
              id: "framer-dark",
              name: "Modern (Dark)",
              styles: {
                backgroundColor: "#1E1E1E", 
                textColor: "#FFFFFF",
                buttonColor: "#0099FF",
                displayColor: "#2D2D2D",
                displayTextColor: "#FFFFFF",
                accentColor: "#0099FF",
                borderRadius: "12px"
              }
            },
            {
              id: "te-op1",
              name: "TE OP-1",
              styles: {
                backgroundColor: "#FFCC00",
                textColor: "#000000",
                buttonColor: "#000000",
                displayColor: "#111111",
                displayTextColor: "#FFFFFF",
                accentColor: "#FF0000",
                borderRadius: "4px"
              }
            },
            {
              id: "te-op1-dark",
              name: "TE OP-1 Dark",
              styles: {
                backgroundColor: "#222222",
                textColor: "#FFFFFF",
                buttonColor: "#FFCC00",
                displayColor: "#000000",
                displayTextColor: "#FFCC00",
                accentColor: "#FFCC00",
                borderRadius: "4px"
              }
            },
            {
              id: "neo-mint",
              name: "Neo Mint",
              styles: {
                backgroundColor: "#BDEED0",
                textColor: "#2A3B47",
                buttonColor: "#0CC0DF",
                displayColor: "#FFFFFF",
                displayTextColor: "#2A3B47",
                accentColor: "#FF6B95",
                borderRadius: "16px"
              }
            },
            {
              id: "vapor-wave",
              name: "Vapor Wave",
              styles: {
                backgroundColor: "#131377",
                textColor: "#FFFFFF",
                buttonColor: "#FF00FF",
                displayColor: "#000000",
                displayTextColor: "#00FFFF",
                accentColor: "#FF00FF",
                borderRadius: "0px"
              }
            },
            {
              id: "ipod-classic",
              name: "iPod Classic",
              styles: {
                backgroundColor: "#ECECEC", // iPod silver body
                textColor: "#000000",
                buttonColor: "#6A6A6A", // Silver button
                displayColor: "#D6DCE4", // Light blue-gray display
                displayTextColor: "#000000",
                accentColor: "#666666", // Changed from Apple blue to dark gray
                borderRadius: "8px"
              }
            }
          ];
        },
        
        // SoundCloud API 로드
        loadSoundCloudAPI: function(callback) {
          if (window.SC && window.SC.Widget) {
            console.log('SoundCloud API가 이미 로드됨');
            if (callback) callback();
            return;
          }
          
          console.log('SoundCloud API 로드 중...');
          const script = document.createElement('script');
          script.src = 'https://w.soundcloud.com/player/api.js';
          script.onload = function() {
            console.log('SoundCloud API 로드 완료');
            if (callback) callback();
          };
          script.onerror = function(e) {
            console.error('SoundCloud API 로드 실패:', e);
          };
          document.head.appendChild(script);
        },
        
        // SoundCloud 플레이어 초기화
        initPlayer: function(iframe) {
          if (!window.SC || !window.SC.Widget) {
            console.warn('SoundCloud API가 로드되지 않았음');
            this.loadSoundCloudAPI(() => this.initPlayer(iframe));
            return;
          }
          
          try {
            const widget = window.SC.Widget(iframe);
            console.log('SoundCloud 위젯 생성됨');
            
            // UI 요소
            const statusDot = document.getElementById('status-dot');
            const playButton = document.getElementById('player-play-btn');
            const progressBar = document.getElementById('progress-bar');
            const timeDisplay = document.getElementById('time-display');
            
            // 필수: 기존 바인딩 제거
            if (this.widget) {
              this.widget.unbind(window.SC.Widget.Events.PLAY);
              this.widget.unbind(window.SC.Widget.Events.PAUSE);
              this.widget.unbind(window.SC.Widget.Events.FINISH);
              this.widget.unbind(window.SC.Widget.Events.READY);
              
              // 기존 타이머 삭제
              if (this.positionInterval) {
                clearInterval(this.positionInterval);
                this.positionInterval = null;
              }
            }
            
            // 위젯 저장
            this.widget = widget;
            
            // 시간 포맷 함수
            function formatTime(ms) {
              const totalSeconds = Math.floor(ms / 1000);
              const minutes = Math.floor(totalSeconds / 60);
              const seconds = totalSeconds % 60;
              return `${minutes}:${seconds < 10 ? '0' + seconds : seconds}`;
            }
            
            // 플레이어 상태 변수 저장 (전역으로 변경)
            window._playerState = {
              isPlaying: false,
              currentPosition: 0,
              duration: 0
            };
            
            const playerState = window._playerState;
            
            // 플레이 버튼 완전히 새로 할당 및 클릭 이벤트 추가
            if (playButton) {
              // 기존 이벤트 리스너 모두 제거
              const newButton = playButton.cloneNode(true);
              playButton.parentNode.replaceChild(newButton, playButton);
              
              // 새 버튼에 이벤트 리스너 추가
              newButton.addEventListener('click', () => {
                console.log('Play/Pause 버튼 클릭됨, 현재 상태:', playerState.isPlaying ? '재생 중' : '일시정지');
                
                if (playerState.isPlaying) {
                  widget.pause();
                } else {
                  widget.play();
                }
              });
            }
            
            // 이벤트 핸들러 
            widget.bind(window.SC.Widget.Events.READY, () => {
              console.log('플레이어 준비 완료, 재생 시작');
              
              // 재생 길이 가져오기
              widget.getDuration(function(d) {
                playerState.duration = d;
                console.log('트랙 길이:', d);
                if (timeDisplay) {
                  timeDisplay.textContent = `0:00 / ${formatTime(d)}`;
                }
              });
              
              // 프로그레스바 클릭 이벤트 (탐색)
              const progressContainer = document.querySelector('.progress-container');
              if (progressContainer) {
                // 기존 이벤트 제거
                const newProgressContainer = progressContainer.cloneNode(true);
                progressContainer.parentNode.replaceChild(newProgressContainer, progressContainer);
                
                // 새 이벤트 추가
                newProgressContainer.addEventListener('click', function(e) {
                  const rect = this.getBoundingClientRect();
                  const x = e.clientX - rect.left;
                  const clickPosition = x / rect.width;
                  
                  // 클릭 위치로 이동 (0-1 사이의 상대적 위치)
                  if (playerState.duration > 0) {
                    const seekPosition = playerState.duration * clickPosition;
                    widget.seekTo(seekPosition);
                    console.log('시크 위치:', seekPosition);
                    
                    // 프로그레스바 UI 바로 업데이트
                    const newProgressBar = document.getElementById('progress-bar');
                    if (newProgressBar) {
                      const percent = (clickPosition * 100);
                      newProgressBar.style.width = `${percent}%`;
                    }
                    
                    const newTimeDisplay = document.getElementById('time-display');
                    if (newTimeDisplay) {
                      newTimeDisplay.textContent = `${formatTime(seekPosition)} / ${formatTime(playerState.duration)}`;
                    }
                  }
                });
              }
              
              widget.play();
            });
            
            widget.bind(window.SC.Widget.Events.PLAY, () => {
              console.log('재생 시작됨');
              playerState.isPlaying = true;
              
              const currentStatusDot = document.getElementById('status-dot');
              if (currentStatusDot) {
                currentStatusDot.classList.add('playing');
              }
              
              // 재생 버튼 아이콘 변경
              const currentPlayButton = document.getElementById('player-play-btn');
              if (currentPlayButton) {
                currentPlayButton.innerHTML = '<svg viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>';
              }
              
              // 타이머 클리어
              if (this.positionInterval) {
                clearInterval(this.positionInterval);
              }
              
              // 새로운 업데이트 타이머 시작
              this.positionInterval = setInterval(function() {
                widget.getPosition(function(position) {
                  console.log('현재 위치:', position, '전체 길이:', playerState.duration);
                  const percent = (position / playerState.duration) * 100;
                  
                  const currentProgressBar = document.getElementById('progress-bar');
                  if (currentProgressBar) {
                    currentProgressBar.style.width = `${percent}%`;
                  }
                  
                  const currentTimeDisplay = document.getElementById('time-display');
                  if (currentTimeDisplay) {
                    currentTimeDisplay.textContent = `${formatTime(position)} / ${formatTime(playerState.duration)}`;
                  }
                });
              }, 500);
            });
            
            widget.bind(window.SC.Widget.Events.PAUSE, () => {
              console.log('일시정지됨');
              playerState.isPlaying = false;
              
              const currentStatusDot = document.getElementById('status-dot');
              if (currentStatusDot) {
                currentStatusDot.classList.remove('playing');
              }
              
              // 재생 버튼 아이콘 변경
              const currentPlayButton = document.getElementById('player-play-btn');
              if (currentPlayButton) {
                currentPlayButton.innerHTML = '<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>';
              }
              
              // 타이머 정지
              if (this.positionInterval) {
                clearInterval(this.positionInterval);
              }
            });
            
            widget.bind(window.SC.Widget.Events.FINISH, () => {
              console.log('재생 완료');
              playerState.isPlaying = false;
              
              const currentStatusDot = document.getElementById('status-dot');
              if (currentStatusDot) {
                currentStatusDot.classList.remove('playing');
              }
              
              // 재생 버튼 아이콘 변경
              const currentPlayButton = document.getElementById('player-play-btn');
              if (currentPlayButton) {
                currentPlayButton.innerHTML = '<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>';
              }
              
              // 타이머 정지
              if (this.positionInterval) {
                clearInterval(this.positionInterval);
              }
              
              // 프로그레스바 초기화
              const currentProgressBar = document.getElementById('progress-bar');
              if (currentProgressBar) {
                currentProgressBar.style.width = '0%';
              }
              
              const currentTimeDisplay = document.getElementById('time-display');
              if (currentTimeDisplay) {
                currentTimeDisplay.textContent = `0:00 / ${formatTime(playerState.duration)}`;
              }
            });
            
            return widget;
          } catch (error) {
            console.error('SoundCloud 플레이어 초기화 오류:', error);
            return null;
          }
        }
      };
    </script>
  </head>
  <body>
    <div class="container">
      <div id="debug-version">
        Chill Mix for Designers
      </div>
      
      <div class="header">
        <!-- SC MICRO title removed -->
      </div>

      <div class="theme-selector">
        <label for="theme-select" class="playlist-title">Themes</label>
        <select id="theme-select">
        </select>
      </div>

      <div class="playlist-container">
        <div class="playlist-title">Tracks</div>
        <div class="track-list" id="track-list">
        </div>
      </div>

      <div id="preview-container" class="empty" style="display: none">
        <div class="preview-player">
          <div class="preview-display">
            <div class="now-playing">
              <span style="text-align: left;">NOW PLAYING</span>
              <div class="status-dot" id="status-dot"></div>
            </div>
            <div class="preview-title" id="preview-title">Select a track</div>
            <div class="preview-artist" id="preview-artist">Choose from the list above</div>
            
            <!-- Custom player interface -->
            <div class="now-playing-container">
              <div class="player-controls">
                <button class="play-button" id="player-play-btn">
                  <svg viewBox="0 0 24 24">
                    <path d="M8 5v14l11-7z"/>
                  </svg>
                </button>
                <div class="progress-container">
                  <div class="progress-bar" id="progress-bar"></div>
                </div>
                <div class="time-display" id="time-display">0:00 / 0:00</div>
              </div>
            </div>
            
            <!-- SoundCloud iframe - hidden but still used for actual audio -->
            <iframe
              id="sc-iframe"
              class="preview-iframe"
              scrolling="no"
              frameborder="no"
              allow="autoplay"
              style="display: none;"
            ></iframe>
          </div>
        </div>
      </div>
      
      <div class="footer">
        &copy; 2025 UX Lab | Corporate Designer Center | LG Electronics
      </div>
    </div>
    
    <script>
      // 페이지 로드 후 DOM 요소 확인 및 UI 초기화
      window.addEventListener('load', function() {
        console.log('페이지 로드 완료');
        
        setTimeout(function() {
          try {
            // Show preview container with empty state
            const previewContainer = document.getElementById('preview-container');
            if (previewContainer) {
              previewContainer.style.display = 'block';
            }
            
            // 1. DOM 요소 확인
            console.log('DOM 요소 확인:');
            const elements = window.debugFigmaPlugin.logDom();
            
            // 2. UI 요소가 모두 있는지 확인
            const allElementsExist = !Object.values(elements).includes(null);
            console.log('모든 DOM 요소 존재: ' + (allElementsExist ? '예' : '아니오'));
            
            // 3. 문제가 있을 경우 백업 솔루션 실행
            if (!allElementsExist || !document.querySelector('#theme-select option')) {
              console.log('일부 UI 요소가 없거나 옵션이 로드되지 않음. 직접 초기화 실행');
              
              // 테마와 트랙 직접 초기화
              const themesLoaded = window.debugFigmaPlugin.checkThemes();
              const tracksLoaded = window.debugFigmaPlugin.createTracks();
              
              if (themesLoaded) {
                console.log('테마가 성공적으로 로드됨');
                
                // 기본 테마 스타일 적용
                const themeSelect = document.getElementById('theme-select');
                if (themeSelect && themeSelect.options.length > 0) {
                  themeSelect.selectedIndex = 0; // Modern (Default) 선택 (인덱스 0)
                  window.debugFigmaPlugin.applyTheme('framer-minimal'); // 초기 테마 적용
                  
                  // 테마 변경 이벤트 핸들러 추가
                  themeSelect.addEventListener('change', function() {
                    console.log('테마 선택 변경됨: ' + this.value);
                    window.debugFigmaPlugin.applyTheme(this.value);
                  });
                }
              }
              
              if (tracksLoaded) {
                console.log('트랙이 성공적으로 로드됨');
              }
              
              // SoundCloud API 로드
              window.debugFigmaPlugin.loadSoundCloudAPI();
              
              // 초기 토스트 메시지
              setTimeout(() => {
                window.debugFigmaPlugin.showToast('✨ 준비됨');
              }, 1000);
            }
          } catch (error) {
            console.error('UI 초기화 중 오류 발생:', error);
          }
        }, 1000);
      });
    </script>

    <script src="./dist/ui.js?v=1.3.1"></script>
  </body>
</html>